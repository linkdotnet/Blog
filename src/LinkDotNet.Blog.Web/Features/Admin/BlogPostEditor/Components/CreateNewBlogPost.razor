@using LinkDotNet.Blog.Domain
@using LinkDotNet.Blog.Infrastructure
@using LinkDotNet.Blog.Infrastructure.Persistence
@using LinkDotNet.Blog.Web.Features.Services
@using NCronJob
@inject IJSRuntime JSRuntime
@inject ICacheInvalidator CacheInvalidator
@inject IInstantJobRegistry InstantJobRegistry
@inject IRepository<ShortCode> ShortCodeRepository
@inject IRepository<BlogPostTemplate> TemplateRepository
@inject IRepository<BlogPost> BlogPostRepository
@inject IToastService ToastService
@inject IOptions<ApplicationConfiguration> AppConfiguration
@inject ICurrentUserService CurrentUserService

<PageTitle>Creating new Blog Post</PageTitle>

<div class="container-fluid px-4">
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="fw-bold text-primary mb-0">@Title</h2>
                <div class="d-flex gap-2 align-items-center">
                    <span class="badge text-body-secondary px-3 py-2 fw-medium">
                        @GetStatusText()
                    </span>
                    @if (model.IsDirty)
                    {
                        <span class="badge bg-warning text-dark px-3 py-2 fw-medium">
                            Unsaved Changes
                        </span>
                    }
                </div>
            </div>
        </div>
    </div>

    <EditForm Model="@model" OnValidSubmit="OnValidBlogPostCreatedAsync">
        <DataAnnotationsValidator />

        <div class="row g-3">
            <!-- Main Content Area - Wider and more prominent -->
            <div class="col-lg-9">
                <!-- Content Card -->
                <div class="card shadow-sm border-0 mb-3">
                    <div class="card-body p-0">
                        <!-- Title -->
                        <div class="p-3 border-bottom">
                            <input type="text" class="form-control form-control-lg border-0 shadow-none fs-3 fw-semibold"
                                   id="title" placeholder="Enter your post title..."
                                   @oninput="args => model.Title = args.Value!.ToString()!"
                                   value="@model.Title"/>
                            <ValidationMessage For="() => model.Title" class="text-danger small mt-1"></ValidationMessage>
                        </div>

                        <!-- Short Description -->
                        <div class="p-3 border-bottom bg-light">
                            <label class="form-label fw-semibold mb-2 text-muted small">SHORT DESCRIPTION</label>
                            <MarkdownTextArea Id="short" Class="form-control border-0 shadow-none bg-light"
                                              Rows="3" Placeholder="Write a compelling summary..."
                                              @bind-Value="@model.ShortDescription"
                                              PreviewFunction="ReplaceShortCodes"></MarkdownTextArea>
                            <ValidationMessage For="() => model.ShortDescription" class="text-danger small mt-1"></ValidationMessage>
                        </div>

                        <!-- Main Content -->
                        <div class="p-3 position-relative">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label fw-semibold mb-0 text-muted small">CONTENT</label>
                                <div class="d-flex gap-2 align-items-center">
                                    <span class="badge bg-secondary">@ReadingTimeCalculator.GetWordCount(model.Content) words</span>
                                    <span class="badge bg-info">~@GetEstimatedReadTime() min read</span>
                                    
                                    <!-- Tools Dropdown -->
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                                                data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="bi bi-tools"></i> Tools
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            @if (blogPostTemplates.Any())
                                            {
                                                <li><h6 class="dropdown-header">Templates</h6></li>
                                                @foreach (var template in blogPostTemplates)
                                                {
                                                    <li>
                                                        <button type="button" class="dropdown-item" @onclick="() => LoadTemplate(template)">
                                                            @template.Name
                                                        </button>
                                                    </li>
                                                }
                                                <li><hr class="dropdown-divider"></li>
                                            }
                                            <li>
                                                <button type="button" class="dropdown-item" @onclick="OpenTemplateDialog">
                                                    <i class="bi bi-file-earmark-plus"></i> Manage Templates
                                                </button>
                                            </li>
                                            @if (shortCodes.Count > 0)
                                            {
                                                <li>
                                                    <button type="button" @onclick="OpenShortCodeDialog" class="dropdown-item">
                                                        <i class="bi bi-code-square"></i> Insert Shortcode
                                                    </button>
                                                </li>
                                            }
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <button type="button" class="dropdown-item" @onclick="FeatureDialog.Open">
                                                    <i class="bi bi-lightbulb"></i> Experimental Features
                                                </button>
                                            </li>
                                            <li>
                                                <button id="convert" type="button" class="dropdown-item" @onclick="ConvertContent">
                                                    <i class="bi bi-arrow-left-right"></i> @ConvertLabel
                                                </button>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <MarkdownTextArea Id="content" Class="form-control border-0 shadow-none"
                                              Rows="30" Placeholder="Start writing your amazing content..."
                                              PreviewFunction="ReplaceShortCodes"
                                              @bind-Value="@model.Content"></MarkdownTextArea>
                            <ValidationMessage For="() => model.Content" class="text-danger small mt-1"></ValidationMessage>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar - Simplified and reorganized -->
            <div class="col-lg-3">
                <!-- Quick Actions - Most important at top -->
                <div class="card shadow-sm border-0 mb-3 sticky-top" style="top: 1rem;">
                    <div class="card-body">
                        <button class="btn btn-primary w-100 fw-semibold mb-2" type="submit" disabled="@(!canSubmit)">
                            <i class="bi bi-check-circle"></i> @(BlogPost != null ? "Update Post" : "Publish Post")
                        </button>
                        <div class="form-check form-switch">
                            <InputCheckbox class="form-check-input" id="published" @bind-Value="model.IsPublished" />
                            <label class="form-check-label fw-semibold" for="published">
                                @(model.IsPublished ? "Public" : "Draft")
                            </label>
                        </div>
                        <ValidationMessage For="() => model.IsPublished" class="text-danger small"></ValidationMessage>
                    </div>
                </div>

                <!-- Tags with Suggestions -->
                <div class="card shadow-sm border-0 mb-3">
                    <div class="card-body">
                        <label class="form-label fw-semibold mb-2">Tags</label>
                        <InputText type="text" class="form-control" id="tags"
                                   placeholder="tech, tutorial, csharp"
                                   @bind-Value="model.Tags" />
                        <ValidationMessage For="() => model.Tags" class="text-danger small mt-1"></ValidationMessage>
                        
                        @if (suggestedTags.Any())
                        {
                            <div class="mt-2">
                                <small class="text-muted d-block mb-1">Popular tags:</small>
                                <div class="d-flex flex-wrap gap-1">
                                    @foreach (var tag in suggestedTags.Take(8))
                                    {
                                        <button type="button" 
                                                class="btn btn-sm btn-outline-secondary"
                                                @onclick="() => AddTag(tag)"
                                                title="Click to add">
                                            @tag
                                        </button>
                                    }
                                </div>
                            </div>
                        }
                        
                        @if (!string.IsNullOrWhiteSpace(model.Tags))
                        {
                            <div class="mt-2">
                                <small class="text-muted d-block mb-1">Current tags:</small>
                                <div class="d-flex flex-wrap gap-1">
                                    @foreach (var tag in model.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries))
                                    {
                                        <span class="badge bg-primary">@tag.Trim()</span>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Publishing Options -->
                <div class="card shadow-sm border-0 mb-3">
                    <div class="card-body">
                        <h6 class="fw-semibold mb-3">Publishing</h6>
                        
                        <div class="mb-3">
                            <label class="form-label small text-muted">Schedule</label>
                            <InputDate Type="InputDateType.DateTimeLocal" class="form-control form-control-sm" id="scheduled"
                                       @bind-Value="model.ScheduledPublishDate"
                                       @bind-Value:after="@(() => model.IsPublished &= !IsScheduled)" />
                            @if (IsScheduled)
                            {
                                <small class="text-info d-block mt-1">
                                    ðŸ“… @model.ScheduledPublishDate?.ToString("MMM dd, yyyy HH:mm")
                                </small>
                            }
                            <ValidationMessage For="() => model.ScheduledPublishDate" class="text-danger small"></ValidationMessage>
                        </div>

                        @if (BlogPost is not null && !IsScheduled)
                        {
                            <div class="form-check form-switch">
                                <InputCheckbox class="form-check-input" id="updatedate" @bind-Value="model.ShouldUpdateDate" />
                                <label class="form-check-label small" for="updatedate">Update date to now</label>
                            </div>
                        }
                        
                        <div class="form-check form-switch mt-2">
                            <InputCheckbox class="form-check-input" id="invalidate-cache" @bind-Value="model.ShouldInvalidateCache" />
                            <label class="form-check-label small" for="invalidate-cache">Clear cache on save</label>
                        </div>
                    </div>
                </div>

                <!-- Advanced Options - Collapsed by default -->
                <div class="accordion" id="advancedOptions">
                    <div class="accordion-item border-0 shadow-sm mb-3">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#imagesCollapse" aria-expanded="false">
                                <small class="fw-semibold">Featured Images</small>
                            </button>
                        </h2>
                        <div id="imagesCollapse" class="accordion-collapse collapse" data-bs-parent="#advancedOptions">
                            <div class="accordion-body">
                                <div class="mb-2">
                                    <label class="form-label small text-muted">Primary Image URL</label>
                                    <InputText type="url" class="form-control form-control-sm" id="preview"
                                               placeholder="https://example.com/image.jpg"
                                               @bind-Value="model.PreviewImageUrl" />
                                    <ValidationMessage For="() => model.PreviewImageUrl" class="text-danger small"></ValidationMessage>
                                </div>
                                <div>
                                    <label class="form-label small text-muted">Fallback Image URL</label>
                                    <InputText type="url" class="form-control form-control-sm" id="fallback-preview"
                                               placeholder="https://example.com/fallback.jpg"
                                               @bind-Value="model.PreviewImageUrlFallback" />
                                    <ValidationMessage For="() => model.PreviewImageUrlFallback" class="text-danger small"></ValidationMessage>
                                </div>
                                <small class="text-muted d-block mt-2">
                                    Fallback ensures compatibility when using WebP/AVIF formats.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </EditForm>
</div>

<FeatureInfoDialog @ref="FeatureDialog"></FeatureInfoDialog>
<ShortCodeDialog @ref="ShortCodeDialog" ShortCodes="shortCodes"></ShortCodeDialog>
<AddTemplateDialog @ref="AddTemplateDialog" OnSave="SaveTemplate"></AddTemplateDialog>

<NavigationLock ConfirmExternalNavigation="@model.IsDirty" OnBeforeInternalNavigation="PreventNavigationWhenDirty"></NavigationLock>

@code {
    [Parameter]
    public BlogPost? BlogPost { get; set; }

    [Parameter, EditorRequired]
    public required string Title { get; set; }

    [Parameter]
    public EventCallback<BlogPost> OnBlogPostCreated { get; set; }

    [Parameter]
    public bool ClearAfterCreated { get; set; } = true;

    private FeatureInfoDialog FeatureDialog { get; set; } = default!;
    private ShortCodeDialog ShortCodeDialog { get; set; } = default!;
    private AddTemplateDialog AddTemplateDialog { get; set; } = default!;

    private CreateNewModel model = new();

    private string? originalContent = null;
    private bool IsContentConverted => !string.IsNullOrWhiteSpace(originalContent);
    private string ConvertLabel => !IsContentConverted ? "Convert to markdown" : "Restore";

    private bool canSubmit = true;
    private IPagedList<ShortCode> shortCodes = PagedList<ShortCode>.Empty;
    private IPagedList<BlogPostTemplate> blogPostTemplates = PagedList<BlogPostTemplate>.Empty;
    private List<string> suggestedTags = new();

    private bool IsScheduled => model.ScheduledPublishDate.HasValue;

    private string? authorName;

    protected override async Task OnInitializedAsync()
    {
        shortCodes = await ShortCodeRepository.GetAllAsync();
        blogPostTemplates = await TemplateRepository.GetAllAsync();

        if (AppConfiguration.Value.UseMultiAuthorMode)
        {
            authorName = await CurrentUserService.GetDisplayNameAsync();
        }

        // Load suggested tags (most used tags)
        await LoadSuggestedTagsAsync();
    }

    protected override void OnParametersSet()
    {
        if (BlogPost is null)
        {
            return;
        }

        model = CreateNewModel.FromBlogPost(BlogPost);
    }

    private string GetStatusText()
    {
        if (BlogPost != null)
        {
            return "Editing";
        }

        if (model.IsPublished)
        {
            return "Ready to Publish";
        }

        if (IsScheduled)
        {
            return "Scheduled";
        }

        return "Draft";
    }

    private int GetEstimatedReadTime()
    {
        if (string.IsNullOrWhiteSpace(model.Content))
            return 1;

        return ReadingTimeCalculator.CalculateReadingTime(model.Content);
    }

    private async Task OnValidBlogPostCreatedAsync()
    {
        canSubmit = false;
        model.AuthorName = authorName;
        await OnBlogPostCreated.InvokeAsync(model.ToBlogPost());
        if (model.ShouldInvalidateCache)
        {
            await CacheInvalidator.ClearCacheAsync();
        }

        _ = InstantJobRegistry.RunInstantJob<SimilarBlogPostJob>(parameter: true);
        ClearModel();
        canSubmit = true;
    }

    private void ClearModel()
    {
        if (ClearAfterCreated)
        {
            model = new CreateNewModel();
        }
    }

    private async Task PreventNavigationWhenDirty(LocationChangingContext context)
    {
        if (!model.IsDirty)
            return;

        var isConfirmed = await JSRuntime.InvokeAsync<bool>("confirm", "You have unsaved changes. Are you sure you want to continue?");

        if (!isConfirmed)
        {
            context.PreventNavigation();
        }
    }

    private Task<string> ReplaceShortCodes(string markdown)
    {
        foreach (var code in shortCodes)
        {
            markdown = markdown.Replace($"[[{code.Name}]]", code.MarkdownContent);
        }

        return Task.FromResult(MarkdownConverter.ToMarkupString(markdown).Value);
    }

    private void OpenShortCodeDialog()
    {
        ShortCodeDialog.Open();
        StateHasChanged();
    }

    private async Task OpenTemplateDialog()
    {
        await AddTemplateDialog.Open();
    }

    private async Task SaveTemplate(string name)
    {
        var existingTemplate = blogPostTemplates.FirstOrDefault(t => t.Name == name);
        if (existingTemplate != null)
        {
            existingTemplate.Update(name, model.Title, model.ShortDescription, model.Content);
            await TemplateRepository.StoreAsync(existingTemplate);
            ToastService.ShowSuccess($"Template {name} updated");
        }
        else
        {
            var template = BlogPostTemplate.Create(name, model.Title, model.ShortDescription, model.Content);
            await TemplateRepository.StoreAsync(template);
            ToastService.ShowSuccess($"Template {name} saved");
        }

        blogPostTemplates = await TemplateRepository.GetAllAsync();
        StateHasChanged();
    }

    private void LoadTemplate(BlogPostTemplate template)
    {
        model.Title = template.Title;
        model.ShortDescription = template.ShortDescription;
        model.Content = template.Content;
        StateHasChanged();
        ToastService.ShowInfo($"Template {template.Name} loaded");
    }

    /// <summary>
    /// Convert content from HTML to Markdown and viceversa
    /// </summary>
    private void ConvertContent()
    {
        if (IsContentConverted)
        {
            model.Content = originalContent!;
            originalContent = null;
        }
        else
        {
            originalContent = model.Content;
            var converter = new ReverseMarkdown.Converter();
            model.Content = converter.Convert(model.Content);
        }
    }

    /// <summary>
    /// Load most frequently used tags from existing blog posts
    /// </summary>
    private async Task LoadSuggestedTagsAsync()
    {
        try
        {
            // Get all published blog posts to analyze their tags
            var blogPosts = await BlogPostRepository.GetAllAsync(
                filter: bp => bp.IsPublished,
                pageSize: 100  // Limit to recent posts for performance
            );

            // Count tag frequency
            var tagFrequency = new Dictionary<string, int>(StringComparer.OrdinalIgnoreCase);
            foreach (var post in blogPosts)
            {
                foreach (var tag in post.Tags)
                {
                    var normalizedTag = tag.Trim();
                    if (!string.IsNullOrWhiteSpace(normalizedTag))
                    {
                        if (tagFrequency.ContainsKey(normalizedTag))
                        {
                            tagFrequency[normalizedTag]++;
                        }
                        else
                        {
                            tagFrequency[normalizedTag] = 1;
                        }
                    }
                }
            }

            // Get top tags sorted by frequency
            suggestedTags = tagFrequency
                .OrderByDescending(kvp => kvp.Value)
                .Take(12)
                .Select(kvp => kvp.Key)
                .ToList();
        }
        catch
        {
            // If there's any error loading tags, just continue with empty list
            suggestedTags = new List<string>();
        }
    }

    /// <summary>
    /// Add a suggested tag to the current tags
    /// </summary>
    private void AddTag(string tag)
    {
        var currentTags = string.IsNullOrWhiteSpace(model.Tags)
            ? new List<string>()
            : model.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries)
                .Select(t => t.Trim())
                .ToList();

        // Only add if not already present
        if (!currentTags.Contains(tag, StringComparer.OrdinalIgnoreCase))
        {
            currentTags.Add(tag);
            model.Tags = string.Join(", ", currentTags);
        }
    }
}
